server:
  port: 8085

spring:
  application:
    name: control-service

  # 数据库配置 - 升级到PostgreSQL支持企业级多租户
  datasource:
    # 开发环境：使用H2内存数据库
    url: jdbc:h2:file:./var/controldb;DB_CLOSE_DELAY=-1;AUTO_SERVER=true
    driverClassName: org.h2.Driver
    username: sa
    password:

    # 生产环境配置示例（通过环境变量覆盖）
    # url: jdbc:postgresql://localhost:5432/pit_control
    # driverClassName: org.postgresql.Driver
    # username: ${DB_USERNAME:pit_user}
    # password: ${DB_PASSWORD:pit_password}

  jpa:
    hibernate:
      ddl-auto: update  # 开发环境自动更新表结构
      # ddl-auto: validate  # 生产环境建议使用validate
    open-in-view: false
    properties:
      hibernate:
        jdbc:
          time_zone: UTC
        dialect: org.hibernate.dialect.H2Dialect  # 开发环境
        # dialect: org.hibernate.dialect.PostgreSQLDialect  # 生产环境
        format_sql: true
        show_sql: false  # 设为true可在开发时查看SQL
    show-sql: false

  # 多环境配置支持
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:development}

  # 安全配置
  security:
    user:
      name: admin
      password: ${ADMIN_PASSWORD:admin123}

# Pit平台配置
pit:
  admin:
    # 管理令牌 - 生产环境必须更换
    token: ${PIT_ADMIN_TOKEN:admin}

  # 多租户配置
  tenant:
    # 默认组织配置
    default-org-tier: FREE
    max-games-per-org:
      free: 5
      pro: 50
      enterprise: 1000

    # 默认配额
    default-quotas:
      free:
        events-per-month: 1000000      # 100万事件/月
        data-retention-days: 90        # 90天数据保留
        max-api-keys: 10              # 最多10个API密钥
      pro:
        events-per-month: 100000000    # 1亿事件/月
        data-retention-days: 365       # 1年数据保留
        max-api-keys: 100             # 最多100个API密钥
      enterprise:
        events-per-month: -1           # 无限制
        data-retention-days: 1095      # 3年数据保留
        max-api-keys: 1000            # 最多1000个API密钥

  # 邀请配置
  invitation:
    expire-hours: 72                   # 邀请链接72小时过期
    base-url: ${PIT_BASE_URL:http://localhost:8085}

  # 安全配置
  security:
    jwt:
      secret: ${JWT_SECRET:pit-jwt-secret-key-change-in-production}
      expiration: 86400000             # 24小时 (毫秒)
    api-key:
      default-rotation-days: 90        # API密钥默认90天轮换
    password:
      min-length: 8
      require-special-chars: true
      require-numbers: true

# 监控和健康检查
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    export:
      prometheus:
        enabled: true

# 日志配置
logging:
  level:
    io.pit: DEBUG                      # 开发环境详细日志
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

---
# 生产环境配置
spring:
  config:
    activate:
      on-profile: production

  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:pit_control}
    driverClassName: org.postgresql.Driver
    username: ${DB_USERNAME:pit_user}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: validate               # 生产环境不自动修改表结构
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: false
        show_sql: false
    show-sql: false

logging:
  level:
    io.pit: INFO                       # 生产环境标准日志级别
    org.springframework.security: WARN
    org.hibernate.SQL: WARN
  file:
    name: /var/log/pit/control-service.log

---
# 测试环境配置
spring:
  config:
    activate:
      on-profile: test

  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driverClassName: org.h2.Driver
    username: sa
    password:

  jpa:
    hibernate:
      ddl-auto: create-drop            # 测试环境每次重新创建表
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect
        format_sql: true
        show_sql: true

logging:
  level:
    io.pit: DEBUG
    org.springframework.security: DEBUG
